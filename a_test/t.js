<<<<<<< Updated upstream
万好家居 4
万家花园 6
万盛家园(别墅) 6
万科城市之光 30
万科海上传奇(一期) 6
万科翡翠四季 5
万达公馆 10
万达华府 82
三家浜公寓采菊苑 1
三景花园 2
上置香岛庄园 1
上置香岛澜湾 1
世合理想大地 54
世合理想大地(别墅) 10
世茂尚景翠苑 13
世茂尚景翠苑(别墅) 1
世茂尚景蓝湾 11
世茂璀璨时代 4
东升苑 3
东方悦宫 12
东方普罗旺斯 33
东方润园 5
东方禾苑 9
东菱宝石公馆 6
东菱宝石公馆(别墅) 3
东菱梅湾花园 2
东菱阳光乐园 6
中兴苑 2
中南公寓 13
中山名都 1
中成新世纪公寓 4
中梁吴越首府 6
中洲花溪地 5
中润嘉兴中心 1
中秀苑 1
中纬大厦 2
丰乐公寓 1
丽江半岛 21
举秀苑 3
久久小区 15
九城嘉佳家 6
云东公寓 3
云洲苑 2
五星苑(一期) 2
亚太花苑 10
亲亲家园 4
仁和苑 3
优优花园 12
余南新苑 10
佳源东方都市 21
佳源优优中环 2
佳源优优华府 2
佳源优优城南 1
佳源优优花园(二期) 11
佳源英伦都市(东区) 4
佳源英伦都市(东区别墅) 1
佳源英伦都市(西区) 11
佳源英伦都市(西区别墅) 1
佳源都市(一期) 1
佳源都市(二期) 2
信源亲水湾 2
信达东郡 4
信达南郡 4
信达南郡(别墅) 1
信达格兰上郡 18
信达翰林兰庭 37
元一柏庄(一期) 6
元一柏庄(二期) 10
农翔社区银柳坊 2
农翔苑 5
凌波苑 2
凤凰花苑 7
凤华丽都(北区) 5
凤华丽都(南区) 2
凤栖桃苑 3
凤栖桃苑(别墅) 1
凤鸣佳苑 1
力宝翡翠花园 2
力宝翡翠花园(别墅) 2
加洲长岛 1
半岛公寓 4
华发雅苑 4
华府国际广场 1
华章御树湾 19
卓越珑府 11
南德大院 40
南江公寓 2
南江苑 1
南秀花园 1
南郊花苑(北区) 5
南郊花苑(南区) 1
南都中心 2
双溪花园(一期) 3
双溪花园(二期) 5
双龙景苑 1
台昇国际广场悦府 27
台昇国际御景园 2
吉杨公寓 3
吉水花园 1
同乐公寓 2
同创颐园 4
同方燕语林苑 10
名典公寓 4
嘉兴万达广场春江中心 2
嘉兴龙鼎万达广场 5
嘉城南都苑 2
嘉城绿都凌霄苑 1
嘉城绿都春兰苑 4
嘉城绿都秋菊苑 3
嘉城绿都芙蓉苑 4
嘉城绿都茉莉苑 1
嘉城绿都铃兰苑 1
嘉禾北京城 2
嘉禾金茂府 3
嘉辉Loft公馆 2
四季观邸 1
城南花园 4
大华城市花园 5
大树彩虹城 29
大树绿苑(南区) 1
大树英格澜 72
大树金港湾 1
大桥湖滨花苑 1
天乐苑 4
天城园林居 6
天明花苑(A区) 2
天明花苑(B区) 1
天香花苑 2
奥山禾堂樾里 1
她他花园 1
好第坊 20
宏润花园 23
宝格丽公馆 35
富安臻园 3
尊贵丽景家园 5
尊贵丽景家园(别墅) 3
巨匠义圣名苑 6
巴黎都市 14
平湖塘花苑 1
幸福家园 6
幸福家园(丰华路) 4
广宜文苑 6
广益大厦 2
庆丰苑 6
府南花园(一区) 7
府南花园(三区) 18
府南花园东(二区) 5
府南花园西(二区) 4
康桥花园 16
当代华府 2
当代华府(别墅) 1
御上江南景园 10
御上江南瑞园 6
御溪花园 8
御翠花苑 2
怡南花园 1
怡和园 10
恒创金色恬园 1
恒大香湖左岸 6
恒大香湖左岸(别墅) 2
承安南湖壹品 7
放鹤洲花园 5
放鹤洲花园(南区) 1
文南里 3
文昌社区 1
文星花园汇龙苑 1
文武里小区 2
文秀里 1
文纬里(南区) 1
文经里 2
文贤公馆 3
文贤苑(东区) 8
文贤苑(西区) 4
文运里 2
新月公寓 6
新湖绿都 1
新贤佳苑 1
新贤园小区 3
新贤润苑 1
旭辉御府 5
明月路16号小区 1
晨凯红树湾 1
景湖花园(东区) 8
景湖花园(西区) 5
景翠里 2
晴湾佳苑(一期) 15
晴湾佳苑(三期) 3
晴湾佳苑(二期) 10
望湖公馆 2
望湖莫奈花园 7
望鹤苑 1
杜鹃坊 1
杨柳湾社区 1
松合里 3
枫杨坊 3
栅堰新村 1
格兰英郡 18
格林小镇 13
桃源东湾 10
桃源小洲 23
桃源小洲(别墅) 3
桃源小镇 2
桃源林语 24
桐庆小区 1
梁林帆影庄 10
梅湘园 1
欣隆盛世欣禧湾 15
步云花苑 3
民丰小区 1
永丰公寓 3
江南国际城 4
江南大厦 2
江南太阳城 2
江南新家园 2
江南新家园渔乐坊 1
江南苑 3
泰富世界城 4
泰富商业广场 1
泾水公寓(东区) 8
泾水公寓(北区) 3
泾水公寓(西区) 2
洪波苑 1
海逸家园 6
清沁苑 3
清河社区 11
清河苑 1
湘湖长岛御墅 1
烟雨名门 2
烟雨社区烟波苑 1
烟雨社区烟雨苑 1
王冠里 2
王安里(北区) 1
王安里(南区) 2
玫瑰恬园 9
环球公馆 18
环球国际 2
现代广场 3
电子中意苑 2
百妙公寓(一期) 3
百妙公寓(二期) 5
百盛花园 1
百绿公寓 1
百花新村 2
百隆花园 1
皇都花苑 13
石堰苑北区(1区) 7
石堰苑北区(2区) 6
石堰苑南区 9
石榴湘湖湾 19
石雪公寓(东区) 2
石雪公寓(北区) 4
石雪公寓(南区) 6
祥生江南新语 2
祥生玖熙花苑 15
祥生白鹤郡 39
祥生白鹤郡(别墅) 1
禾东公寓(北区) 1
禾峰乾庄 7
禾峰乾庄(别墅) 8
禾峰传奇 10
禾源新都(北区) 5
禾源新都(南区) 9
秀城公寓 1
秀沁苑 1
秋泾公寓 9
穆湖花园阳光苑 1
紫元尚园 4
紫元尚宸 2
紫城悦澜湾 8
紫澜别墅 6
紫竹名苑 2
紫轩公寓 1
紫金艺境 30
紫金豪庄 1
绿地新都会 5
绿地新里城 49
绿地海顿公馆 5
绿城春风十里 98
绿城留香园 6
绿景华庭 4
绿景名邸 10
绿溪玫瑰园1区 1
绿溪玫瑰园北区 8
绿溪玫瑰园南区 6
罗马都市(一期) 13
罗马都市(一期别墅) 2
罗马都市(二期) 10
美迪家园 1
翠湖壹号 10
翠湖壹号(别墅) 2
翰林府第 5
英才公寓 1
茗品悦府 4
荣安府 10
荣盛富盛名邸(别墅) 2
荣盛观湖景园 2
菜花泾社区 1
菱香坊 1
蓝光名仕公馆 2
蓝光名仕公馆(别墅) 1
蓝天嘉苑 14
蔚蓝澳洲中心 1
蔚蓝澳洲花园 9
虹桥新村 1
西园里小区 8
西马桥社区 5
赞成丽景苑 8
赞成学仕苑 1
赞成新都名邸 5
赞成清华府邸 5
赞成紫景雅苑 1
越秀北苑 1
越秀花园 1
越秀里小区 1
越运里小区 2
远洋绿洲 1
郁金香岸 5
都市文涛苑 3
金地都会艺境 11
金桥假日丽厦 2
金桥名苑 1
金穗月亮湾 24
金都夏宫 14
金都夏宫(别墅) 4
鑫控吴越学府 6
铂金府邸 30
银河湾 10
长新公寓(北区) 13
长新公寓(南1区) 10
长新公寓(南2区) 7
阳光广场月河苑 1
隆兴公寓(东区) 2
隆兴公寓(北区) 9
隆兴公寓(南区) 6
隆腾广场 2
雅居乐金茂中央公园 5
雨润天阁 1
青年大厦 1
风清云都 1
香樟国际 25
香橼别墅 7
香港兴业御缇湾 2
香港兴业御缇湾(别墅) 1
香缇世家(别墅) 2
香缇御峰 2
骏园 10
鹤翔里 1
鹭栖湖 2
黄鹤花园 1
黎明苑(一期) 1
黎明苑(三期) 2
黎明苑(二期) 2
龙之梦悦庭 3
龙润壹城 8
龙鼎国际公馆 1
=======
function(queries, selectedCard) {
    Loading.Show();
    var doPost = ""
    var params = {}
    var deviceType = top.SsCenter.deviceInfo.current.deviceType;
    var business = settingCommandDual.business;
    if (deviceType == "SYNLOCKV3") {
      doPost = "setSYNLOCKV3executeTL1_Sync";
      params = settingCommandDual.getDefaultOneCommand("RTRV-COND-EQPT")

    }
    var bindCard = settingCommandDual.currentCards = []
    if (deviceType == "TSG3800") {
      if (settingCommandDual.business == "input") {
        doPost = "setTSG3800executeTL1_Sync";
        params = { "aid": "INP", "command": "RTRV-COND-INP" }

        var oCard = {}
        top.SsServer[doPost + "_n"](params).done(function(ret) {
          (ret.data || []).forEach(function(r) {

            if (r.aid && r.aid.match(/(\d+)-(\d+)$/)) {
              var matched = r.aid.match(/(\S+)(\d+)-(\d+)$/)
              // type card port 
              if (!(matched[2] in oCard)) {
                oCard[matched[2]] = { "card": matched[2], "ports": [], "name": matched[1] + matched[2] }
              }
              oCard[matched[2]]["ports"].push({ "port": matched[3], "name": r.aid })
            }

          })
          bindCard = Object.values(oCard) || [];
          bindCard.sort(function(x, y) {
            return x.card - y.card;
          })
          settingCommandDual.currentCards = bindCard;

        })
      } else {

      }

    }

    if (deviceType == "GNSS97" &&
      (settingCommandDual.business == "output" ||
        settingCommandDual.business == "input" ||
        settingCommandDual.business == "clock" ||
        settingCommandDual.business == "system")) {

      doPost = "setGNSS97executeTL1_Sync";
      params = { "aid": "", "command": "RTRV-EQPT" }

      var oCard = {}
      top.SsServer[doPost + "_n"](params).done(function(ret) {
        (ret.data || []).forEach(function(r) {
          var re = "";
          if (settingCommandDual.business == "input") {
            re = "S";
          } else if (settingCommandDual.business == "output") {
            re = "a"
          } else if (settingCommandDual.business == "clock") {
            re = "K"
          } else if (settingCommandDual.business == "system") {
            re = "K"
          }

          if (settingCommandDual.business == "system") {
            if (r.type && r.type == re) {
              top.SsServer[doPost + "_n"]({ "aid": r.aid, "command": "RTRV-EQPT" }).done(function(rr) {
                if (rr.data.msmode == "MAIN") {
                  settingCommandDual.mainAidGNSS97 = rr.data.aid;
                }

              })
            }


          } else {


            if (r.type && r.type == re) {
              var codeToBard = settingCommandDual.codeToBardGNSS97;

              var doPorts = []
              if (settingCommandDual.business == "input") {
                doPorts = [
                  { "port": 1, "name": 1 },
                  { "port": 2, "name": 2 },
                  { "port": 3, "name": 3 },
                  { "port": 4, "name": 4 },
                  { "port": 5, "name": 5 },
                  { "port": 6, "name": 6 },
                  { "port": 7, "name": 7 },
                  { "port": 8, "name": 8 },
                ]
              }

              // type card 
              oCard[codeToBard[r.aid]] = { "card": codeToBard[r.aid], "ports": doPorts, "name": r.aid }
            }

          }



        })

      })

      if (settingCommandDual.deviceType == "GNSS97" && settingCommandDual.business == "system") {
        // 主用 aid;
        return;
      }

      bindCard = Object.values(oCard) || [];
      bindCard.sort(function(x, y) {
        return x.card - y.card;
      })
      settingCommandDual.currentCards = bindCard;

    }


    if (deviceType == "TP1100" && settingCommandDual.business != "system") {
      // input output system clock
      doPost = "setExecuteTP1100Command_Sync";
      params = { "aid": "", "command": "rtrvCraft" }

      var oCard = {}
      top.SsServer[doPost + "_n"](params).done(function(ret) {
        (ret.data || []).forEach(function(r) {
          var re = "";
          if (settingCommandDual.business == "input") {
            re = /INP|PRS/
          } else if (settingCommandDual.business == "output") {
            re = /OUT/
          } else if (settingCommandDual.business == "clock") {
            re = /IOC/
          }
          // else   if (settingCommandDual.business == "system") { 
          //   re=/SYS/
          // }

          if (r.name && r.name.match(re)) {
            var matched = r.name.match(re)
            // type card 
            oCard[r.name] = { "card": r.name, "ports": [], "name": r.name }
          }
        })

      })

      bindCard = Object.values(oCard) || [];
      bindCard.sort(function(x, y) {
        return x.card - y.card;
      })
      settingCommandDual.currentCards = bindCard;

    }




    if (!doPost) { return }
    // 板卡  业务名  ，端口名  [{"板卡":{"name":1,ports:["1":{}]}]
    var ret = []

    if (deviceType == "SYNLOCKV3") {
      top.SsServer[doPost](params).done(function(result) {
        ret = result.data || [];

        $.each(ret, function(oi, ov) {
          if (deviceType == "SYNLOCKV3") {
            var oneCard = ov.card;


            var re = "";
            if (settingCommandDual.business == "input") {
              if (oneCard.condtype != "MASTNOR") {
                return true;
              }
              re = /LCIM(\d+)/
              if (oneCard.name.match(re)) {
                var uncentainty = oneCard.name.match(re)[1] == 1 || oneCard.name.match(re)[1] == 2;
                isMeasure = true;
                if (uncentainty) {

                  top.SsServer[doPost + "_n"]({ "command": "RTRV-STATE-LCIM", "cmdtype": "TYPE", "aid": oneCard.name }).done(function(
                    r) {
                    if (r.data.boardtype == "INPUT") {
                      isMeasure = false;
                    }
                    if (r.data.boardtype == "UNCFG") {
                      return true;
                    }
                  });
                }
                if ($(".nav-left a.three-active").html() == "输入测试") {
                  if (isMeasure) {
                    bindCard.push({
                      "ports": [],
                      "cardType": "LCIM",
                      "card": oneCard.name.match(re)[1],
                      "name": oneCard
                        .name,
                      "condtype": oneCard.condtype
                    })
                  }
                  return true;
                } else {
                  if (!isMeasure) {
                    bindCard.push({
                      "ports": [],
                      "cardType": "LCIM",
                      "card": oneCard.name.match(re)[1],
                      "name": oneCard
                        .name,
                      "condtype": oneCard.condtype
                    })
                  } else {
                    return true;
                  }
                }

              }
              if ($(".nav-left a.three-active").html() != "输入测试") {
                re = /SOCU(\d+)|SRCU(\d+)/
                if (oneCard.name.match(re)) {
                  bindCard.push({
                    "ports": [],
                    "cardType": "SCLK",
                    "card": "CLOCK",
                    "name": oneCard.name,
                    "condtype": oneCard
                      .condtype
                  })
                }
                return true;
              }


            }
            if (settingCommandDual.business == "output") {
              if (oneCard.condtype != "MASTNOR") {
                return true;
              }
              re = /TSOU(\d+)/
              if (oneCard.name.match(re)) {
                bindCard.push({
                  "ports": [],
                  "cardType": "TSOU",
                  "card": oneCard.name.match(re)[1],
                  "name": oneCard
                    .name,
                  "condtype": oneCard.condtype
                })
              }
              return true;
            }
            if (settingCommandDual.business == "clock") {
              if (oneCard.condtype != "MASTNOR" && oneCard.condtype != "BACKNOR") {
                return true;
              }
              re = /SOCU(\d+)|SRCU(\d+)/
              if (oneCard.name.match(re)) {
                bindCard.push({
                  "ports": [],
                  "card": oneCard.name.match(re)[1] || oneCard.name.match(re)[2],
                  "name": oneCard
                    .name,
                  "condtype": oneCard.condtype
                })
              }
              return true;

            }
            if (settingCommandDual.business == "system") {
              // if (oneCard.condtype != "MASTNOR"&&oneCard.condtype != "BACKNOR") {
              //    return true;
              // }
              bindCard.push({ "ports": [], "card": oneCard.name, "name": oneCard.name, "condtype": oneCard.condtype })
              return true;

            }





          }
        })
        if (bindCard.length > 0 && ($.inArray(settingCommandDual.business, ["input", "output"]) >= 0)) {
          var toGetPort = null;
          if (selectedCard) {
            var tempCard = bindCard.filter(function(x) { return x.card == selectedCard })
            if (tempCard.length > 0) {
              toGetPort = tempCard[0]
            }
          } else {
            toGetPort = bindCard[0];
          }
          if (toGetPort && toGetPort.name) {
            var todoPost = []
            todoPost.push(top.SsServer[doPost + "_n"]({
              "aid": toGetPort.name,
              "command": "RTRV-STATE-" + toGetPort
                .cardType,
              "cmdtype": "CHANTYPE"
            }))
            if (settingCommandDual.business == "input") {
              todoPost.push(top.SsServer[doPost + "_n"]({ "aid": "", "command": "RTRV-COND-INP" }))
            }

            $.when(...todoPost).done(function(...ret) {
              if (todoPost.length == 1) {
                ret = [ret]
                var ports = ret[0][0].data.channelList;
                ports = ports.map(function(x) {

                  var simpPort = x.channelID.match(/(\d+)$/)
                  if (simpPort) {
                    simpPort = simpPort[1]
                  }
                  return { "port": simpPort, "name": x.channelID, "channeltype": x.channeltype }
                })
                ports = ports.filter(function(x) { return x })
                toGetPort["ports"] = ports;

              } else {

                if (ret[0][1] == "success" || ret[1][1] == "success") {
                  var ports = ret[0][0].data.channelList;
                  var buss = ret[1][0].data;
                  var buss = buss.map(function(x) { return x.aid });
                  ports = ports.map(function(x) {
                    if ($.inArray(x.channelID, buss) >= 0 && x.channeltype != "NONE") {
                      var simpPort = x.channelID.match(/(\d+)$/)
                      if (simpPort) {
                        simpPort = simpPort[1]
                      }
                      return { "port": simpPort, "name": x.channelID, "channeltype": x.channeltype }
                    }
                  })
                  ports = ports.filter(function(x) { return x })
                  toGetPort["ports"] = ports;

                }

              }

            })


          }
        }


      }).fail(function(err) {

      })
    }


    if (queries.conditions) {
      settingCommandDual.qBindings = {};



      queries.conditions.forEach(function(c) {
        if (c.field == "inputCardConfigId") {
          var cardBind = settingCommandDual.qBindings[c["binding"]] = []
          bindCard.forEach(function(one) {
            cardBind.push({ "Name": one.card, "Value": one.card });
          })
        }
      })
      queries.conditions.forEach(function(c) {
        if (c.field == "inputCardConfigPortId") {

          if (bindCard.length > 0) {
            var toGetPort = bindCard[0];
            if (selectedCard) {
              var tempCard = bindCard.filter(function(x) { return x.Name == selectedCard })
              if (tempCard.length > 0) {
                toGetPort = tempCard[0]
              }
            }


            settingCommandDual.qBindings[c["binding"]] = []

            $.each((toGetPort.ports || []), function(oi, one) {
              settingCommandDual.qBindings[c["binding"]].push({ "Name": one.port, "Value": one.port });
            })
          }
        }

      })

    }
  }
>>>>>>> Stashed changes
