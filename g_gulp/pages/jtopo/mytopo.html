<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="../../static/js/jquery-1.11.1.min.js"></script>
    <script src="jtopo-0.4.8-min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/lib/bootstrap-3.3.7/dist/css/bootstrap.min.css">
    <script type="text/javascript" src="../../static/lib/bootstrap-3.3.7/dist/js/bootstrap.min.js"></script>


    <style>
        #contextmenu {
            border: 1px solid #aaa;
            border-bottom: 0;
            background: #eee;
            position: absolute;
            list-style: none;
            margin: 0;
            padding: 0;
            display: none;
            z-index: 999;
        }

        #contextmenu li a {
            display: block;
            padding: 10px;
            border-bottom: 1px solid #aaa;
            cursor: pointer;
        }


        .canvas-box {
            position: relative;
            height: 100%;
        }

        .canvas-box .canvas-content {
            cursor: pointer;
            border: 1px red solid;
        }

        .canvas-box .node-list {
            position: absolute;
            top: 20%;
            height: 100px;
            right: 30px;
            width: 220px;
            z-index: 999;
        }

        .canvas-box .node-list .node-list-right li {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .canvas-box .node-list .node-list-right li>img {
            width: 30px;
            height: 25px;
            margin-right: 20px;
        }

        .cricle {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>


</head>

<body>
    <ul id="contextmenu" style="display:none;">
        <li><a>暂时无效</a></li>
        <li><a>暂时无效</a></li>
        <li><a>删除该节点</a></li>
    </ul>


    <div class="canvas-box">
        <canvas class="canvas-content" id="canvas" height="338" width="1350" style="cursor: default;">

        </canvas>
        <div class="node-list">
            <ul class="node-list-right">
                <li><button type="button" class="btn btn-default btn-xs save" id="save" data-index="2">保存</button></li>


                <li><img src="../../images/net_topo/routerNode.png" class="nav-drag" draggable="true"
                        data-type="router"><span class="cricle" style="background-color:#00FB00;"></span>
                    <span>正常</span></li>
                <li><img src="../../images/net_topo/netNode1.png" class="nav-drag" draggable="true"
                        data-type="node"><span class="cricle" style="background-color:#FF0000;"></span><span>严重警告</span>
                </li>
                <li><img src="../../images/net_topo/netNode2.png" class="nav-drag" draggable="true"
                        data-type="node"><span class="cricle" style="background-color:#FE7E1C;"></span><span>主要警告</span>
                </li>
                <li><img src="../../images/net_topo/netNode3.png" class="nav-drag" draggable="true"
                        data-type="node"><span class="cricle" style="background-color:#FFAA00;"></span><span>次要警告</span>
                </li>
                <li><img src="../../images/net_topo/netNode4.png" class="nav-drag" draggable="true"
                        data-type="node"><span class="cricle" style="background-color:#108EE9;"></span><span>事件</span>
                </li>

                <li><img src="../../images/net_topo/services.png" class="nav-drag" draggable="true" data-type="node">

                    <img src="../../images/net_topo/connect.png" class="nav-drag" draggable="true" data-type="router">
                </li>

            </ul>
        </div>
    </div>
</body>

<script>
    var topologyO = {
        createNode: {
            newNode: null,
            currentNode: null,
            // 划线
            beginNode: null,
            currentLink: null,
            endNode: null,
            tempNodeA: null,
            tempNodeZ: null,
            setNewNode: function (imageUrl) {
                var netNode = new JTopo.Node();
                netNode.setImage(imageUrl, true);
                netNode.setLocation(320, 80);
                netNode.showSelected = false;
                netNode.addEventListener('mouseup', function (e) {
                    if (e.button == 2) { // 右键
                        topologyO.createNode.currentNode = this;
                        // 当前位置弹出菜单（div）
                        $("#contextmenu").css({
                            top: e.pageY,
                            left: e.pageX
                        }).show();
                        return;
                    }

                    topologyO.createNode.tempNodeA = new JTopo.Node('tempA');;
                    topologyO.createNode.tempNodeA.setSize(1, 1);
                    topologyO.createNode.tempNodeZ = new JTopo.Node('tempZ');;
                    topologyO.createNode.tempNodeZ.setSize(1, 1);

                    var link = new JTopo.Link(topologyO.createNode.tempNodeA, topologyO.createNode
                        .tempNodeZ);
                    

                    if (e.target != null && e.target instanceof JTopo.Node) {
                        if (topologyO.createNode.beginNode == null) {
                            topologyO.createNode.beginNode = e.target;
                            topologyO.canvasInfo.obj.scene.add(link);
                            topologyO.createNode.tempNodeA.setLocation(e.x, e.y);
                            topologyO.createNode.tempNodeZ.setLocation(e.x, e.y);
                        } else if (topologyO.createNode.beginNode !== e.target) {
                            topologyO.createNode.endNode = e.target;
                            var l = new JTopo.Link(topologyO.createNode.beginNode, topologyO.createNode
                                .endNode);
                                l.addEventListener('mouseup', function (e) {
                                if (e.button == 2) { // 右键
                                    topologyO.createNode.currentLink = this;
                                    // 当前位置弹出菜单（div）
                                    $("#contextmenu").css({
                                        top: e.pageY,
                                        left: e.pageX
                                    }).show();
                                    return;
                                }
                    })
                            topologyO.canvasInfo.obj.scene.add(l);
                            topologyO.createNode.beginNode = null;
                            topologyO.canvasInfo.obj.scene.remove(link);
                        } else {
                            topologyO.createNode.beginNode = null;
                        }
                    } else {
                        topologyO.canvasInfo.obj.scene.remove(link);
                    }

                });

                topologyO.createNode.newNode = netNode;
            },


            init: function ($el) {
                $el.ondragstart = function (e) {
                    topologyO.createNode.setNewNode($el.src);
                }
                $el.ondragend = function (e) {
                    topologyO.createNode.newNode = null;
                }



            }
        },

        canvasInfo: {
            obj: null,
            init: function () {
                var canvas = document.getElementById('canvas');
                var stage;
                var scene;


                stage = new JTopo.Stage(canvas);
                scene = new JTopo.Scene(stage);
                scene.background = '../../images/net_topo/bg.jpg';

                stage.click(function (event) {
                    if (event.button == 0) { // 右键
                        // 关闭弹出菜单（div）
                        $("#contextmenu").hide();
                    }
                });


                topologyO.canvasInfo.obj = {
                    "stage": stage,
                    "scene": scene,
                }
                // 创建动作 生成topo node;
                canvas.ondragenter = function (e) {
                    console.log('handle_enter-当元素进入目的地时触发')
                    // 阻止浏览器默认行为
                    e.preventDefault()
                }

                canvas.ondragover = function (e) {
                    e.preventDefault()
                }
                canvas.ondrop = function (e) {
                    console.log('handle_drop-当元素在目的地放下时触发')
                    var t = Date.now()
                    if (topologyO.createNode.newNode) {
                        topologyO.createNode.newNode["x"] = e.x
                        topologyO.createNode.newNode["y"] = e.y
                        topologyO.canvasInfo.obj.scene.add(topologyO.createNode.newNode);
                    }
                    topologyO.createNode.newNode = null;
                    e.preventDefault()
                }


                $.each($(".node-list-right img"), function (indexInArray, valueOfElement) {
                    topologyO.createNode.init(valueOfElement);
                });


                /* 右键菜单处理 */
                $("#contextmenu a").click(function () {
                    var text = $(this).text();
                    if (text == '删除该节点') {
                        if(topologyO.createNode.currentNode){

                            topologyO.canvasInfo.obj.scene.remove(topologyO.createNode.currentNode);
                            topologyO.createNode.currentNode = null;
                        }else{
                            topologyO.canvasInfo.obj.scene.remove(topologyO.createNode.currentLink);
                            topologyO.createNode.currentLink = null;
                        }


                    }
                    $("#contextmenu").hide();
                });



                $("#save").click(function () {
                    console.log(topologyO.canvasInfo.obj.stage.toJson())
                })
            }
        }


    }
    topologyO.canvasInfo.init();
</script>


</html>